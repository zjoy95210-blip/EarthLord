# 《地球新主》产品需求文档 (PRD)

**版本**: 2.0
**日期**: 2025-12-27
**技术栈**: SwiftUI + Supabase + MapKit

---

## 1. 项目概述

### 1.1 产品定位
《地球新主》是一款基于真实地理位置（LBS）的末日生存策略游戏。玩家通过在现实世界中行走来圈占领地、探索废墟获取资源、建造设施发展基地，并与其他幸存者进行交易和通讯。

### 1.2 核心理念
- **Walk to Earn**: 走路即产出，将运动与游戏深度结合
- **真实地图圈地**: 用双脚在真实世界划定领地边界
- **末日生存主题**: 希望朋克视觉风格，废土重建叙事
- **LBS社交**: 基于地理位置的交易与无线电通讯

### 1.3 商业模式
- 订阅制（开拓者月卡 $9.99/月、领主通行证 $19.99/月）
- 一次性购买（物资包 $0.99 ~ $9.99）

---

## 2. 目标用户

| 用户类型 | 特征描述 | 占比预估 |
|---------|---------|---------|
| **核心用户** | 18-35岁游戏玩家，喜欢策略/生存类游戏 | 50% |
| **次要用户** | 热爱户外运动、跑步健身的人群 | 30% |
| **潜在用户** | 《宝可梦GO》、Keep、跑步类App用户 | 20% |

**用户画像**:
- 每日愿意步行 30分钟以上
- 对末日生存题材有兴趣
- 喜欢收集、建造、社交玩法
- 习惯使用手机App记录运动

---

## 3. 核心功能列表

### P0 - 核心功能（MVP必须）

| 功能模块 | 功能点 | 描述 |
|---------|-------|------|
| **用户系统** | 登录注册 | 邮箱/Apple/Google登录 |
| **圈地系统** | GPS轨迹圈地 | 行走闭环占领土地 |
| **探索系统** | POI发现与搜刮 | 探索真实地标获取资源 |
| **付费系统** | 内购订阅 | StoreKit 2 集成 |

### P1 - 重要功能（第二阶段）

| 功能模块 | 功能点 | 描述 |
|---------|-------|------|
| **建造系统** | 建筑建造 | 在领地内建造15种建筑 |
| **背包系统** | 物品管理 | 背包容量、物品使用 |
| **交易系统** | 玩家交易 | 以物易物、位置限制 |
| **通讯系统** | 消息中心 | 官方消息、系统通知 |
| **通讯系统** | 公共频道 | 3km范围实时聊天 |
| **生存体征** | 饥饿/水分 | 持续消耗机制 |

### P2 - 增强功能（第三阶段）

| 功能模块 | 功能点 | 描述 |
|---------|-------|------|
| **建造系统** | 建筑状态管理 | 升级、维修、损坏 |
| **通讯系统** | 频道管理 | 创建/加入私人频道 |
| **通讯系统** | PTT语音 | 按住说话功能 |
| **通讯系统** | 设备等级 | 收音机→对讲机→电台→卫星 |
| **成长系统** | 排行榜 | 领地/探索/建筑榜 |
| **成长系统** | 成就系统 | 多等级稀有度成就 |

---

## 4. 功能详细描述

### 4.1 圈地系统（P0）

#### 4.1.1 GPS轨迹圈地

**流程**:
```
点击[开始圈地] → 实时绘制轨迹 → 回到起点(20m内) → 闭合验证 → 领地确权
```

**规则**:
| 参数 | 数值 |
|------|------|
| 最小面积 | 100 m² |
| 最大面积 | 10,000 m²（普通用户） |
| 闭合距离 | 起点20米范围内 |
| 速度限制 | 1-15 km/h（防作弊） |
| 重叠检测 | 不允许与他人领地重叠 |

**验收标准**:
- [ ] GPS定位误差 < 10米
- [ ] 轨迹实时绘制，延迟 < 1秒
- [ ] 闭合后自动计算面积
- [ ] 作弊检测（速度异常、位置跳跃）

#### 4.1.2 领地管理

| 功能 | 描述 |
|------|------|
| 领地命名 | 自定义名称，最长20字符 |
| 领地详情 | 显示面积、建筑数量、创建时间 |
| 交易开关 | 开启/关闭"允许交易" |
| 活跃规则 | 30天内开始建设，90天保持活跃 |

---

### 4.2 探索系统（P0）

#### 4.2.1 POI发现与搜刮

**POI类型与资源映射**:
| POI类型 | 产出资源 | 稀有度 |
|---------|---------|--------|
| 🏥 医院/药店 | 药品、急救包、抗生素 | 稀有 |
| 🏪 超市/餐厅 | 罐头食品、饮用水 | 普通 |
| 🏭 工厂/工地 | 金属材料、零件 | 普通 |
| 🌲 公园/林地 | 木材、纤维 | 普通 |
| 🏦 银行/珠宝店 | 稀有材料、电子元件 | 史诗 |
| ⛽ 加油站 | 燃料 | 稀有 |

**搜刮机制**:
| 参数 | 数值 |
|------|------|
| 触发距离 | 50米范围内 |
| 冷却时间 | 同一POI 4小时 |
| 产出数量 | 1-5件（随机） |

---

### 4.3 建造系统（P1）

#### 建筑列表

**Tier 1 - 生存基础**:
| 建筑 | 消耗资源 | 功能 |
|------|---------|------|
| 篝火 | 石头×20, 木材×30 | 取暖，防止夜间体力下降 |
| 庇护所 | 木材×50, 布料×20 | 休息恢复，加速体力回复 |
| 集水器 | 金属×10, 玻璃×5 | 每日产出饮用水 |

**Tier 2 - 功能扩展**:
| 建筑 | 消耗资源 | 功能 |
|------|---------|------|
| 小仓库 | 木材×100, 金属×50 | 扩展背包容量+50 |
| 农田 | 种子×10, 工具×5 | 每日产出食物 |
| 工作台 | 金属×80, 工具×10 | 可合成高级物品 |

**Tier 3 - 高级设施**:
| 建筑 | 消耗资源 | 功能 |
|------|---------|------|
| 太阳能板 | 电子元件×20, 金属×100 | 提供电力 |
| 营地电台 | 卫星模块×1, 电子×50 | 通讯范围10km |
| 医疗站 | 药品×100, 医疗设备×10 | 自动恢复生命值 |

---

### 4.4 交易系统（P1）

**交易流程**:
```
卖家发布挂单 → 买家进入100米范围 → 看到挂单 → 接受交易 → 物品自动交换
```

**规则**:
- 以物易物，无货币系统
- 需进入卖家领地100米范围
- 挂单72小时后自动下架

---

### 4.5 通讯系统（P1/P2）

#### 设备等级与范围

```
[收音机] → [对讲机] → [营地电台] → [卫星通讯]
  只接收      3km         10km          全球
```

#### 功能矩阵

| 功能 | P1 | P2 | 描述 |
|------|----|----|------|
| 官方消息 | ✓ | | 生存指南、每日任务 |
| 系统通知 | ✓ | | 交易请求、领地入侵 |
| 公共频道 | ✓ | | 3km范围实时聊天 |
| 私人频道 | | ✓ | 用户创建，邀请加入 |
| PTT语音 | | ✓ | 长按说话，松开发送 |

---

## 5. 数据模型概要

### 核心表结构

```sql
-- 用户表
profiles (
    id UUID PRIMARY KEY,
    username TEXT,
    avatar_url TEXT,
    level INT DEFAULT 1,
    experience INT DEFAULT 0,
    created_at TIMESTAMPTZ
)

-- 领地表
territories (
    id UUID PRIMARY KEY,
    user_id UUID REFERENCES profiles(id),
    name TEXT,
    geometry GEOMETRY(POLYGON, 4326),  -- PostGIS
    area FLOAT,
    status TEXT DEFAULT 'active',
    created_at TIMESTAMPTZ
)

-- 建筑表
buildings (
    id UUID PRIMARY KEY,
    territory_id UUID REFERENCES territories(id),
    building_type TEXT,
    level INT DEFAULT 1,
    status TEXT DEFAULT 'building',
    position_x FLOAT,
    position_y FLOAT,
    created_at TIMESTAMPTZ
)

-- 物品/背包表
items (
    id UUID PRIMARY KEY,
    user_id UUID REFERENCES profiles(id),
    item_type TEXT,
    quantity INT,
    created_at TIMESTAMPTZ
)

-- POI表
pois (
    id TEXT PRIMARY KEY,
    name TEXT,
    poi_type TEXT,
    latitude FLOAT,
    longitude FLOAT,
    last_scavenged_at TIMESTAMPTZ,
    discovered_by UUID REFERENCES profiles(id)
)

-- 交易表
trades (
    id UUID PRIMARY KEY,
    seller_id UUID REFERENCES profiles(id),
    buyer_id UUID,
    offer_items JSONB,
    request_items JSONB,
    status TEXT DEFAULT 'pending',
    territory_id UUID REFERENCES territories(id),
    created_at TIMESTAMPTZ
)

-- 消息表
messages (
    id UUID PRIMARY KEY,
    channel_id UUID,
    user_id UUID REFERENCES profiles(id),
    content TEXT,
    message_type TEXT DEFAULT 'text',
    created_at TIMESTAMPTZ
)

-- 生存体征表
vital_signs (
    id UUID PRIMARY KEY,
    user_id UUID REFERENCES profiles(id) UNIQUE,
    health INT DEFAULT 100,
    hunger INT DEFAULT 100,
    thirst INT DEFAULT 100,
    updated_at TIMESTAMPTZ
)
```

### 实体关系图

```
profiles ─┬─< territories ─< buildings
          │
          ├─< items
          │
          ├─< trades
          │
          ├─< messages
          │
          └── vital_signs
```

---

## 6. 技术架构

### 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                      iOS App (Swift)                         │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │   SwiftUI   │  │   MapKit    │  │    CoreLocation     │  │
│  │   (UI层)    │  │   (地图)    │  │    (GPS定位)        │  │
│  └─────────────┘  └─────────────┘  └─────────────────────┘  │
│                                                              │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │  StoreKit2  │  │  SwiftData  │  │  Supabase SDK       │  │
│  │   (内购)    │  │  (本地存储)  │  │  (网络/实时)        │  │
│  └─────────────┘  └─────────────┘  └─────────────────────┘  │
│                                                              │
├─────────────────────────────────────────────────────────────┤
│                          网络层                              │
│                     HTTPS / WebSocket                        │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    Supabase Backend                          │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │   Auth      │  │  Database   │  │     Realtime        │  │
│  │ (认证服务)  │  │ PostgreSQL  │  │   (WebSocket)       │  │
│  │            │  │  + PostGIS  │  │                     │  │
│  └─────────────┘  └─────────────┘  └─────────────────────┘  │
│                                                              │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │  Storage    │  │   Edge      │  │     RLS Policy      │  │
│  │ (文件存储)  │  │  Functions  │  │   (行级安全)        │  │
│  └─────────────┘  └─────────────┘  └─────────────────────┘  │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### 关键技术选型

| 层级 | 技术 | 用途 |
|------|------|------|
| UI | SwiftUI | 声明式界面开发 |
| 地图 | MapKit | 地图显示、POI查询 |
| 定位 | CoreLocation | GPS轨迹记录 |
| 存储 | SwiftData | 本地数据缓存 |
| 内购 | StoreKit 2 | 订阅与一次性购买 |
| 后端 | Supabase | BaaS一站式服务 |
| 数据库 | PostgreSQL + PostGIS | 地理空间数据存储 |
| 实时 | Supabase Realtime | WebSocket消息推送 |
| 认证 | Supabase Auth | OAuth + 邮箱认证 |

### 数据流

```
用户操作 → SwiftUI View → ViewModel → SupabaseService → Supabase API
                                              ↓
                                        PostgreSQL
                                              ↓
                                     Realtime → 其他客户端
```

---

## 7. 里程碑计划

### Phase 1: MVP（核心闭环）

**目标**: 可圈地、可探索的基础版本

| 功能 | 交付物 |
|------|-------|
| 用户系统 | 邮箱/Apple登录 |
| GPS圈地 | 轨迹绘制、闭合验证、领地存储 |
| POI探索 | MapKit POI识别、搜刮奖励 |
| 基础UI | 5个Tab框架、末日主题 |

### Phase 2: 资源循环

**目标**: 完整的资源获取与消耗循环

| 功能 | 交付物 |
|------|-------|
| 背包系统 | 物品存储、使用、容量 |
| 建造系统 | Tier1-2建筑、建造流程 |
| 生存体征 | 饥饿、水分、消耗机制 |
| 交易系统 | 挂单、位置验证、交易完成 |

### Phase 3: 社交通讯

**目标**: 玩家间互动功能

| 功能 | 交付物 |
|------|-------|
| 消息中心 | 官方消息、系统通知 |
| 公共频道 | 3km范围聊天 |
| 私人频道 | 创建、邀请、管理 |
| PTT语音 | 按住说话功能 |

### Phase 4: 成长与商业化

**目标**: 完整的成长系统与变现

| 功能 | 交付物 |
|------|-------|
| 排行榜 | 领地/探索/建筑三榜 |
| 成就系统 | 多稀有度成就 |
| 订阅内购 | 月卡、通行证 |
| 多语言 | 简中/繁中/英文 |

---

## 附录

### A. 风险与缓解

| 风险 | 影响 | 缓解措施 |
|------|------|---------|
| GPS精度不足 | 圈地体验差 | 增加容错范围，提供手动调整 |
| 作弊问题 | 游戏平衡破坏 | 多维度反作弊检测 |
| POI数据不全 | 探索内容少 | 补充虚拟POI点 |
| 苹果审核 | 上架延迟 | 提前熟悉审核指南 |

### B. 性能指标

| 指标 | 目标值 |
|------|-------|
| GPS定位响应 | < 1秒 |
| 地图加载 | < 2秒 |
| API响应 | < 500ms |
| App启动 | < 3秒 |

---

**文档结束**
